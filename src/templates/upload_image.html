<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ぼかしマジック</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', path='/css/styles.css') }}" rel="stylesheet">
  </head>
  <body class="container py-4">
    <h1 class="mb-4">ぼかしマジック</h1>

    <div class="usage-guide mb-4">
      <div class="usage-header" data-bs-toggle="collapse" data-bs-target="#usageContent" aria-expanded="false" aria-controls="usageContent">
        <h5 class="mb-0">
          <i class="bi bi-info-circle me-2"></i>使い方
          <i class="bi bi-chevron-down float-end"></i>
        </h5>
      </div>
      <div class="collapse" id="usageContent">
        <div class="usage-body">
          <ol>
            <li>「画像を選択」ボタンをクリックして、編集したい画像をアップロードします。</li>
            <li>画像上でマウスをドラッグして、ぼかしを適用したい範囲を選択します。</li>
            <li>選択した範囲に自動的にぼかし処理が適用されます。</li>
            <li>必要に応じて以下の操作を行えます：
              <ul>
                <li>「1つ前に戻す」: 直前のぼかし処理を取り消します</li>
                <li>「クリア」: すべてのぼかし処理をリセットします</li>
                <li>「画像をダウンロード」: 編集した画像を保存します</li>
              </ul>
            </li>
          </ol>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-center">
      <form id="uploadForm" action="/upload" enctype="multipart/form-data" method="post">
        <div class="file-upload">
          <label class="file-upload-label">
            画像を選択
            <input id="fileInput" name="file" type="file" accept="image/*" onchange="document.getElementById('uploadForm').submit()">
          </label>
        </div>
      </form>

      <div class="alert alert-info mb-0 ms-3" role="alert" style="background: none; border: none;">
        {{ file_name }}
      </div>
    </div>
    
    <div class="canvas-container">
      <div class="button-container">
        <button class="btn btn-action" onclick="imageEditor.clearCanvas()" id="clearButton" disabled>
          <i class="bi bi-arrow-counterclockwise"></i> クリア
        </button>
        <button class="btn btn-undo" onclick="imageEditor.undoLastAction()" id="undoButton" disabled>
          <i class="bi bi-arrow-left"></i> 1つ前に戻す
        </button>
        <button class="btn btn-download" onclick="imageEditor.downloadImage('{{ file_name }}')" id="downloadButton" disabled>
          <i class="bi bi-download"></i> 画像をダウンロード
        </button>
        <div class="processing-indicator" id="processingIndicator">処理中...</div>
        <div class="color-select-container">
          <div class="color-select-button" onclick="colorPicker.toggleDropdown()">
            <div class="color-sample" id="selectedColorSample"></div>
          </div>
          <div class="color-select-dropdown" id="colorDropdown">
            <div class="color-option" onclick="colorPicker.selectColor('#FF0000')">
              <div class="color-sample" style="background-color: #FF0000;"></div>
            </div>
            <div class="color-option" onclick="colorPicker.selectColor('#FFFF00')">
              <div class="color-sample" style="background-color: #FFFF00;"></div>
            </div>
            <div class="color-option" onclick="colorPicker.selectColor('#00FFFF')">
              <div class="color-sample" style="background-color: #00FFFF;"></div>
            </div>
            <div class="color-option" onclick="colorPicker.selectColor('#FFFFFF')">
              <div class="color-sample" style="background-color: #FFFFFF;"></div>
            </div>
            <div class="color-option" onclick="colorPicker.selectColor('#000000')">
              <div class="color-sample" style="background-color: #000000;"></div>
            </div>
            <div class="color-option" onclick="colorPicker.selectColor('#00FF00')">
              <div class="color-sample" style="background-color: #00FF00;"></div>
            </div>
          </div>
        </div>
      </div>
      <canvas id="imageCanvas"></canvas>
    </div>

    <!-- エラーモーダル -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">エラー</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger mb-0">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <span id="errorMessage"></span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { ImageEditor } from '{{ url_for("static", path="/js/imageEditor.js") }}';

      // グローバルスコープに必要なオブジェクトを公開
      window.imageEditor = new ImageEditor('imageCanvas');
      window.colorPicker = imageEditor.colorPicker;

      // 初期画像の読み込み
      const fileContent = "{{ file_content|safe if file_content else '' }}";
      const contentType = "{{ content_type if content_type else '' }}";
      if (fileContent && contentType) {
        imageEditor.loadImage(`data:${contentType};base64,${fileContent}`, true);
      }
    </script>
  </body>
</html>
