<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>画像編集 - ぼかし処理ツール</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root {
        --primary-color: #4A90E2;
        --secondary-color: #6C7A89;
        --accent-color: #5C6BC0;
        --hover-color: #357ABD;
        --shadow-color: rgba(108, 122, 137, 0.15);
      }

      body {
        background-color: #F8F9FA;
      }

      h1 {
        color: var(--secondary-color);
        font-weight: 600;
      }

      .canvas-container {
        position: relative;
        display: block;
        margin: 20px 0;
        box-shadow: 0 4px 12px var(--shadow-color);
        border-radius: 8px;
        overflow: hidden;
        background: white;
        width: fit-content;
      }

      #imageCanvas {
        display: block;
        max-width: 100%;
        height: auto;
      }

      .button-container {
        margin: 0;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
        padding: 10px 15px;
        background-color: #f8f9fa;
        width: 100%;
        position: static;
        box-sizing: border-box;
      }

      .button-container button {
        margin: 0;
        flex-shrink: 0;
      }

      .file-upload {
        position: relative;
        display: inline-block;
        margin: 20px 0;
      }

      .file-upload-label {
        display: inline-block;
        padding: 12px 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        box-shadow: 0 2px 6px var(--shadow-color);
      }

      .file-upload-label:hover {
        background: var(--hover-color);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .file-upload input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }

      .btn {
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px var(--shadow-color);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .btn-action {
        background-color: var(--secondary-color);
        border: none;
        color: white;
      }

      .btn-action:hover {
        background-color: #5B6978;
        color: white;
      }

      .btn-undo {
        background-color: var(--accent-color);
        border: none;
        color: white;
      }

      .btn-undo:hover {
        background-color: #4A5BA9;
        color: white;
      }

      .btn-download {
        background-color: var(--primary-color);
        border: none;
        color: white;
      }

      .btn-download:hover {
        background-color: var(--hover-color);
        color: white;
      }

      .alert-info {
        background-color: rgba(74, 144, 226, 0.1);
        border-color: rgba(74, 144, 226, 0.2);
        color: var(--primary-color);
        border-radius: 6px;
      }

      .usage-guide {
        border: 1px solid rgba(74, 144, 226, 0.15);
        border-radius: 6px;
        overflow: hidden;
        font-size: 0.9em;
      }

      .usage-header {
        background-color: rgba(74, 144, 226, 0.05);
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .usage-header:hover {
        background-color: rgba(74, 144, 226, 0.1);
      }

      .usage-header h5 {
        color: var(--primary-color);
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1em;
      }

      .usage-body {
        padding: 12px 15px;
        background-color: white;
      }

      .usage-body ol {
        padding-left: 18px;
        margin-bottom: 0;
      }

      .usage-body ul {
        padding-left: 18px;
        margin-top: 5px;
      }

      .usage-body li {
        margin-bottom: 5px;
        line-height: 1.4;
      }

      .usage-body li:last-child {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body class="container py-4">
    <h1 class="mb-4">画像ぼかしツール</h1>

    <div class="usage-guide mb-4">
      <div class="usage-header" data-bs-toggle="collapse" data-bs-target="#usageContent" aria-expanded="false" aria-controls="usageContent">
        <h5 class="mb-0">
          <i class="bi bi-info-circle me-2"></i>使い方
          <i class="bi bi-chevron-down float-end"></i>
        </h5>
      </div>
      <div class="collapse" id="usageContent">
        <div class="usage-body">
          <ol>
            <li>「画像を選択」ボタンをクリックして、編集したい画像をアップロードします。</li>
            <li>画像上でマウスをドラッグして、ぼかしを適用したい範囲を選択します。</li>
            <li>選択した範囲に自動的にぼかし処理が適用されます。</li>
            <li>必要に応じて以下の操作を行えます：
              <ul>
                <li>「1つ前に戻す」: 直前のぼかし処理を取り消します</li>
                <li>「クリア」: すべてのぼかし処理をリセットします</li>
                <li>「画像をダウンロード」: 編集した画像を保存します</li>
              </ul>
            </li>
          </ol>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-center">
      <form id="uploadForm" action="/upload" enctype="multipart/form-data" method="post">
        <div class="file-upload">
          <label class="file-upload-label">
            画像を選択
            <input id="fileInput" name="file" type="file" accept="image/*" onchange="document.getElementById('uploadForm').submit()">
          </label>
        </div>
      </form>

      <div class="alert alert-info mb-0 ms-3" role="alert" style="background: none; border: none;">
        アップロードされたファイル: {{ file_name }}
      </div>
    </div>
    
    <div class="canvas-container">
      <div class="d-flex gap-2 p-2 bg-light border-bottom">
        <button class="btn btn-action" onclick="clearCanvas()" id="clearButton" disabled>
          <i class="bi bi-arrow-counterclockwise"></i> クリア
        </button>
        <button class="btn btn-undo" onclick="undoLastAction()" id="undoButton" disabled>
          <i class="bi bi-arrow-left"></i> 1つ前に戻す
        </button>
        <button class="btn btn-download" onclick="downloadImage()" id="downloadButton" disabled>
          <i class="bi bi-download"></i> 画像をダウンロード
        </button>
      </div>
      <canvas id="imageCanvas"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const canvas = document.getElementById('imageCanvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let currentY = 0;
        let imageData = null;
        let originalImageData = null;
        let selectedRect = null;
        let imageHistory = [];
        let scale = 1;

        function updateCanvasWithImage(imgSrc, isInitialLoad = false) {
          const newImg = new Image();
          newImg.onload = function() {
            canvas.width = newImg.width;
            canvas.height = newImg.height;
            ctx.drawImage(newImg, 0, 0);
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (isInitialLoad) {
              originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              imageHistory = [ctx.getImageData(0, 0, canvas.width, canvas.height)];
              document.getElementById('clearButton').disabled = true;
            }
            selectedRect = null;
            scale = canvas.width / canvas.getBoundingClientRect().width;
          };
          newImg.src = imgSrc;
        }

        const fileContent = "{{ file_content|safe if file_content else '' }}";
        const contentType = "{{ content_type if content_type else '' }}";
        if (fileContent && contentType) {
          updateCanvasWithImage(`data:${contentType};base64,${fileContent}`, true);
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        function getScaledCoordinates(e) {
          const rect = canvas.getBoundingClientRect();
          return {
            x: (e.clientX - rect.left) * scale,
            y: (e.clientY - rect.top) * scale
          };
        }

        function startDrawing(e) {
          isDrawing = true;
          const coords = getScaledCoordinates(e);
          startX = coords.x;
          startY = coords.y;
          currentX = startX;
          currentY = startY;
          selectedRect = null;
        }

        function draw(e) {
          if (!isDrawing) return;
          
          const coords = getScaledCoordinates(e);
          currentX = coords.x;
          currentY = coords.y;
          
          ctx.putImageData(imageData, 0, 0);
          
          if (isDrawing) {
            ctx.strokeStyle = 'var(--primary-color)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.rect(startX, startY, currentX - startX, currentY - startY);
            ctx.stroke();
            ctx.setLineDash([]);
          }
        }

        function stopDrawing() {
          if (isDrawing) {
            selectedRect = {
              x: Math.min(startX, currentX),
              y: Math.min(startY, currentY),
              width: Math.abs(currentX - startX),
              height: Math.abs(currentY - startY)
            };
            
            ctx.putImageData(imageData, 0, 0);
            
            if (selectedRect.width > 0 && selectedRect.height > 0) {
              applyBlur();
            }
          }
          isDrawing = false;
        }

        function clearCanvas() {
          if (originalImageData) {
            ctx.putImageData(originalImageData, 0, 0);
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            selectedRect = null;
            
            imageHistory = [];
            document.getElementById('undoButton').disabled = true;
            document.getElementById('downloadButton').disabled = true;
            document.getElementById('clearButton').disabled = true;
          }
        }

        function undoLastAction() {
          if (imageHistory.length > 0) {
            const lastState = imageHistory.pop();
            ctx.putImageData(lastState, 0, 0);
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            if (imageHistory.length === 0) {
              document.getElementById('undoButton').disabled = true;
              document.getElementById('downloadButton').disabled = true;
              document.getElementById('clearButton').disabled = true;
            }
          }
        }

        function applyBlur() {
          if (!selectedRect) {
            alert('ぼかす領域を選択してください');
            return;
          }

          imageHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));

          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = selectedRect.width;
          tempCanvas.height = selectedRect.height;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(canvas,
            selectedRect.x, selectedRect.y, selectedRect.width, selectedRect.height,
            0, 0, selectedRect.width, selectedRect.height
          );

          tempCanvas.toBlob(function(blob) {
            const formData = new FormData();
            formData.append('image', blob);

            fetch('/apply_blur', {
              method: 'POST',
              body: formData
            })
            .then(response => response.blob())
            .then(blob => {
              const url = URL.createObjectURL(blob);
              const blurredImg = new Image();
              blurredImg.onload = function() {
                ctx.putImageData(imageData, 0, 0);
                ctx.drawImage(blurredImg, selectedRect.x, selectedRect.y);
                imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                document.getElementById('undoButton').disabled = false;
                document.getElementById('downloadButton').disabled = false;
                document.getElementById('clearButton').disabled = false;
              };
              blurredImg.src = url;
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ぼかし処理中にエラーが発生しました');
              imageHistory.pop();
            });
          }, 'image/png');
        }

        function downloadImage() {
          const dataURL = canvas.toDataURL('image/png');
          
          const originalName = '{{ file_name }}';
          const lastDotIndex = originalName.lastIndexOf('.');
          const newFileName = lastDotIndex !== -1
            ? originalName.substring(0, lastDotIndex) + '_blurred' + originalName.substring(lastDotIndex)
            : originalName + '_blurred';
          
          const link = document.createElement('a');
          link.download = newFileName;
          link.href = dataURL;
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        window.addEventListener('resize', function() {
          scale = canvas.width / canvas.getBoundingClientRect().width;
        });
      }
    </script>
  </body>
</html>
